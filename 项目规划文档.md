# é¡¹ç›®è§„åˆ’æ–‡æ¡£ï¼šå®‰å…¨ç®¡ç†äº¤äº’é¡µé¢

## éœ€æ±‚åˆ†æä¸å®Œå–„

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œæœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªå®‰å…¨ç®¡ç†äº¤äº’é¡µé¢ç³»ç»Ÿï¼Œå°†éƒ¨ç½²åœ¨Cloudflare Workersä¸Šã€‚ç³»ç»ŸåŒ…å«4ä¸ªä¸»è¦é¡µé¢ï¼š
1. è§†é¢‘é¡µé¢(å®‰å…¨ç‰ˆ)ï¼šå±•ç¤º"éµå®ˆè§„ç« åˆ¶åº¦-å®‰å…¨"ä¸»é¢˜è§†é¢‘
2. è§†é¢‘é¡µé¢(ä¸å®‰å…¨ç‰ˆ)ï¼šå±•ç¤º"è¿è§„æ“ä½œ-ä¸å®‰å…¨"ä¸»é¢˜è§†é¢‘
3. ç­”é¢˜é¡µé¢(æŒ‰ç« æ“ä½œ)ï¼šæµ‹è¯•ç”¨æˆ·å®‰å…¨æ„è¯†ï¼Œæ»¡åˆ†å±•ç¤ºæ­å–œç‰¹æ•ˆ
4. ç­”é¢˜é¡µé¢(è¿è§„æ“ä½œ)ï¼šæµ‹è¯•è§„é¿è¿ç« èƒ½åŠ›ï¼Œæ»¡åˆ†å±•ç¤ºæ­å–œç‰¹æ•ˆ

éœ€æ±‚å®Œå–„ï¼š
- éœ€æ˜ç¡®è§†é¢‘é“¾æ¥æ¥æº
- éœ€ç¡®å®š10é“é¢˜ç›®å†…å®¹åŠç­”æ¡ˆ
- å»ºè®®æ·»åŠ é¦–é¡µä½œä¸ºå¯¼èˆªå…¥å£
- å»ºè®®æ·»åŠ ç»“æœè®°å½•åŠŸèƒ½
- å¢åŠ é€‚é…PCç«¯çš„å¸ƒå±€è®¾è®¡

## ç”¨æˆ·æ—…ç¨‹è®¾è®¡

ä¸ºç¡®ä¿è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œç³»ç»Ÿè®¾è®¡äº†æ¸…æ™°çš„ç”¨æˆ·æ—…ç¨‹æµç¨‹ï¼š

```mermaid
graph TD
    A[é¦–é¡µ] --> B[å®‰å…¨è§†é¢‘]
    A --> C[ä¸å®‰å…¨è§†é¢‘]
    A --> D[æŒ‰ç« æ“ä½œç­”é¢˜]
    A --> E[è¿è§„æ“ä½œç­”é¢˜]
    B --> F[è§†é¢‘æ’­æ”¾å®Œæˆ]
    C --> F
    F --> A
    D --> G[ç­”é¢˜è¿›è¡Œä¸­]
    E --> G
    G --> H{æ˜¯å¦æ»¡åˆ†?}
    H -->|æ˜¯| I[æ˜¾ç¤ºæ­å–œç‰¹æ•ˆ]
    H -->|å¦| J[æ˜¾ç¤ºå¾—åˆ†]
    I --> A
    J --> A
```

## ç•Œé¢åŸå‹è®¾è®¡

### 1. é¦–é¡µå¸ƒå±€
```
+------------------+
|    é¡µé¢æ ‡é¢˜      |
+------------------+
|   [å®‰å…¨è§†é¢‘]    |
|                  |
|   [ä¸å®‰å…¨è§†é¢‘]  |
|                  |
|   [æŒ‰ç« ç­”é¢˜]    |
|                  |
|   [è¿è§„ç­”é¢˜]    |
+------------------+
```

### 2. è§†é¢‘é¡µé¢å¸ƒå±€
```
+------------------+
|   è§†é¢‘æ ‡é¢˜       |
+------------------+
|                  |
|    è§†é¢‘æ’­æ”¾     |
|     åŒºåŸŸ        |
|                  |
+------------------+
|   è¿”å›æŒ‰é’®      |
+------------------+
```

### 3. ç­”é¢˜é¡µé¢å¸ƒå±€
```
+------------------+
|   é¢˜ç›® (1/10)   |
+------------------+
|   é—®é¢˜æè¿°...    |
+------------------+
|   â–¡ é€‰é¡¹A       |
|   â–¡ é€‰é¡¹B       |
|   â–¡ é€‰é¡¹C       |
|   â–¡ é€‰é¡¹D       |
+------------------+
|   æäº¤æŒ‰é’®      |
+------------------+
```

### 4. æ­å–œç‰¹æ•ˆè®¾è®¡
```
+------------------+
|    ğŸ‰ æ­å–œ ğŸ‰    |
|                  |
|   æ»¡åˆ†é€šè¿‡ï¼    |
|                  |
|   [åŠ¨ç”»æ•ˆæœ]    |
|                  |
|   è¿”å›é¦–é¡µ      |
+------------------+
```

## é¡¹ç›®æ¶æ„è®¾è®¡

é‡‡ç”¨å•é¡µåº”ç”¨(SPA)è®¾è®¡ï¼Œä½¿ç”¨çº¯HTMLã€CSSå’ŒJavaScriptå®ç°ã€‚æ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š

```
å®‰å…¨ç®¡ç†äº¤äº’é¡µé¢
â”‚
â”œâ”€â”€ æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ è·¯ç”±ç®¡ç† - æ§åˆ¶é¡µé¢åˆ‡æ¢
â”‚   â”œâ”€â”€ çŠ¶æ€ç®¡ç† - ç®¡ç†åº”ç”¨çŠ¶æ€
â”‚   â””â”€â”€ å·¥å…·å‡½æ•° - å…¬å…±å‡½æ•°åº“
â”‚
â”œâ”€â”€ é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ é¦–é¡µç»„ä»¶ - å¯¼èˆªå…¥å£
â”‚   â”œâ”€â”€ è§†é¢‘æ’­æ”¾ç»„ä»¶ - å¤„ç†è§†é¢‘æ’­æ”¾é€»è¾‘
â”‚   â””â”€â”€ ç­”é¢˜ç»„ä»¶ - å¤„ç†ç­”é¢˜é€»è¾‘
â”‚
â””â”€â”€ èµ„æºç®¡ç†
    â”œâ”€â”€ æ ·å¼èµ„æº - CSSæ ·å¼
    â”œâ”€â”€ é—®é¢˜åº“ - å­˜å‚¨é¢˜ç›®æ•°æ®(Cloudflare KV)
    â””â”€â”€ ç‰¹æ•ˆèµ„æº - å­˜å‚¨æ­å–œç‰¹æ•ˆèµ„æº
```

## ç›®æ ‡åˆ†è§£

â–¡ æ­å»ºåŸºç¡€é¡¹ç›®æ¡†æ¶ï¼Œå®ç°SPAè·¯ç”±ç³»ç»Ÿ
â–¡ å®ç°é¦–é¡µå¯¼èˆªç•Œé¢ï¼Œæä¾›å››ä¸ªä¸»è¦åŠŸèƒ½å…¥å£
â–¡ å¼€å‘è§†é¢‘æ’­æ”¾ç»„ä»¶ï¼Œæ”¯æŒè‡ªåŠ¨å…¨å±åŠŸèƒ½
â–¡ å®ç°ä¸¤ä¸ªä¸åŒä¸»é¢˜çš„è§†é¢‘é¡µé¢
â–¡ å¼€å‘ç­”é¢˜ç»„ä»¶ï¼Œæ”¯æŒé¢˜ç›®å±•ç¤ºã€é€‰æ‹©å’Œè¯„åˆ†
â–¡ å®ç°ä¸¤ä¸ªä¸åŒä¸»é¢˜çš„ç­”é¢˜é¡µé¢
â–¡ è®¾è®¡å¹¶å®ç°æ­å–œç‰¹æ•ˆç³»ç»Ÿ
â–¡ å¼€å‘ç»“æœç»Ÿè®¡å’Œå±•ç¤ºåŠŸèƒ½
â–¡ ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒï¼Œç¡®ä¿åœ¨æ‰‹æœºä¸Šæ­£å¸¸è¿è¡Œ
â–¡ æµ‹è¯•å’Œè°ƒè¯•ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šå¯é 
â–¡ æ‰“åŒ…éƒ¨ç½²åˆ°Cloudflare Workers
â–¡ åœ¨Cloudflare KVä¸­é…ç½®é¢˜åº“æ•°æ®

## è¯¦ç»†å®ç°è§„åˆ’

### æ¨¡å—ä¸€ï¼šæ ¸å¿ƒç³»ç»Ÿ

#### åŠŸèƒ½æè¿°
å®ç°å•é¡µåº”ç”¨æ¡†æ¶ï¼ŒåŒ…æ‹¬è·¯ç”±ç³»ç»Ÿã€çŠ¶æ€ç®¡ç†å’ŒåŸºç¡€å·¥å…·å‡½æ•°ã€‚

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
 * åŠŸèƒ½ï¼šè®¾ç½®åˆå§‹çŠ¶æ€ï¼ŒåŠ è½½å¿…è¦èµ„æºï¼Œå¯åŠ¨è·¯ç”±ç³»ç»Ÿ
 */
function initApp() {
    // åˆå§‹åŒ–åº”ç”¨çŠ¶æ€
    // æ³¨å†Œè·¯ç”±äº‹ä»¶
    // åŠ è½½åˆå§‹é¡µé¢
}

/**
 * è·¯ç”±ç®¡ç†å™¨
 * åŠŸèƒ½ï¼šæ§åˆ¶é¡µé¢è·³è½¬ï¼Œç»´æŠ¤å†å²è®°å½•
 * å‚æ•°ï¼šroute - ç›®æ ‡è·¯ç”±
 * è¿”å›å€¼ï¼šæ— 
 */
function navigateTo(route) {
    // ä¿å­˜å½“å‰çŠ¶æ€
    // æ›´æ–°URL
    // åŠ è½½å¯¹åº”é¡µé¢ç»„ä»¶
}

/**
 * çŠ¶æ€ç®¡ç†å™¨
 * åŠŸèƒ½ï¼šç®¡ç†å…¨å±€çŠ¶æ€æ•°æ®
 * å‚æ•°ï¼škey - çŠ¶æ€é”®å, value - çŠ¶æ€å€¼
 * è¿”å›å€¼ï¼šæ— 
 */
function setState(key, value) {
    // æ›´æ–°çŠ¶æ€
    // è§¦å‘UIæ›´æ–°
}

/**
 * è·å–åº”ç”¨çŠ¶æ€
 * åŠŸèƒ½ï¼šè·å–æŒ‡å®šçŠ¶æ€æ•°æ®
 * å‚æ•°ï¼škey - çŠ¶æ€é”®å
 * è¿”å›å€¼ï¼šçŠ¶æ€å€¼
 */
function getState(key) {
    // è¿”å›æŒ‡å®šçŠ¶æ€
}
```

### æ¨¡å—äºŒï¼šé¡µé¢ç»„ä»¶

#### åŠŸèƒ½æè¿°
å®ç°å„ä¸ªé¡µé¢çš„UIç»„ä»¶å’Œäº¤äº’é€»è¾‘ã€‚

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * æ¸²æŸ“é¦–é¡µ
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºå››ä¸ªä¸»è¦åŠŸèƒ½å…¥å£
 * å‚æ•°ï¼šcontainer - å®¹å™¨å…ƒç´ 
 * è¿”å›å€¼ï¼šæ— 
 */
function renderHomePage(container) {
    // åˆ›å»ºé¡µé¢å…ƒç´ 
    // ç»‘å®šäº‹ä»¶å¤„ç†ç¨‹åº
    // æ·»åŠ åˆ°å®¹å™¨
}

/**
 * æ¸²æŸ“è§†é¢‘é¡µé¢
 * åŠŸèƒ½ï¼šå…¨å±æ’­æ”¾è§†é¢‘
 * å‚æ•°ï¼šcontainer - å®¹å™¨å…ƒç´ , videoType - è§†é¢‘ç±»å‹(å®‰å…¨/ä¸å®‰å…¨)
 * è¿”å›å€¼ï¼šæ— 
 */
function renderVideoPage(container, videoType) {
    // åˆ›å»ºè§†é¢‘å…ƒç´ 
    // è·å–è§†é¢‘æº
    const videoUrl = videoSources[videoType];
    
    // åˆ›å»ºè§†é¢‘åµŒå…¥HTML
    const videoHTML = `
    <div style="padding: 56.25% 0 0 0; position: relative">
        <div style="height:100%;left:0;position:absolute;top:0;width:100%">
            <iframe height="100%" width="100%;" src="${videoUrl}" 
            frameborder="0" allow="autoplay; fullscreen" scrolling="no"></iframe>
        </div>
    </div>`;
    
    // å°†è§†é¢‘æ·»åŠ åˆ°å®¹å™¨
    container.innerHTML = videoHTML;
    
    // æ£€æµ‹ç§»åŠ¨è®¾å¤‡å¹¶å¯ç”¨å…¨å±
    if (getState('deviceType') === 'mobile') {
        enableFullscreen(container.querySelector('iframe'));
    }
}

/**
 * æ’­æ”¾è§†é¢‘
 * åŠŸèƒ½ï¼šæ§åˆ¶è§†é¢‘æ’­æ”¾é€»è¾‘
 * å‚æ•°ï¼švideoElement - è§†é¢‘å…ƒç´ , autoFullscreen - æ˜¯å¦è‡ªåŠ¨å…¨å±
 * è¿”å›å€¼ï¼šæ— 
 */
function playVideo(videoElement, autoFullscreen) {
    // æ’­æ”¾è§†é¢‘
    // æ ¹æ®å‚æ•°å¯ç”¨å…¨å±
    // ç›‘å¬æ’­æ”¾å®Œæˆäº‹ä»¶
    
    // åµŒå…¥å¼è§†é¢‘iframeç”±Wave.videoæä¾›è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
    if (autoFullscreen) {
        enableFullscreen(videoElement);
    }
    
    // ç›‘å¬è§†é¢‘æ¶ˆæ¯äº‹ä»¶ï¼Œç”¨äºæ£€æµ‹æ’­æ”¾ç»“æŸ
    window.addEventListener('message', (event) => {
        // å‡è®¾Wave.videoåœ¨æ’­æ”¾ç»“æŸæ—¶å‘é€ç‰¹å®šæ¶ˆæ¯
        if (event.data && event.data.type === 'videoEnded') {
            navigateTo('home'); // è§†é¢‘ç»“æŸåè¿”å›é¦–é¡µ
        }
    });
}

/**
 * æ¸²æŸ“ç­”é¢˜é¡µé¢
 * åŠŸèƒ½ï¼šæ˜¾ç¤ºé¢˜ç›®å¹¶å¤„ç†ç­”é¢˜é€»è¾‘
 * å‚æ•°ï¼šcontainer - å®¹å™¨å…ƒç´ , quizType - ç­”é¢˜ç±»å‹(æŒ‰ç« æ“ä½œ/è¿è§„æ“ä½œ)
 * è¿”å›å€¼ï¼šæ— 
 */
function renderQuizPage(container, quizType) {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
    
    // åŠ è½½é¢˜åº“
    loadQuestions(quizType)
        .then(questions => {
            if (questions.length === 0) {
                container.innerHTML = '<div class="error">é¢˜åº“åŠ è½½å¤±è´¥</div>';
                return;
            }
            
            // æ¢å¤ä¸Šæ¬¡ç­”é¢˜è¿›åº¦
            const savedProgress = loadProgress(quizType);
            if (savedProgress) {
                setState('answers', savedProgress);
            }
            
            // åˆ›å»ºç­”é¢˜ç•Œé¢
            createQuizInterface(container, questions, quizType);
            
            // å¯åŠ¨è®¡æ—¶å™¨
            startQuizTimer();
        })
        .catch(error => {
            container.innerHTML = `<div class="error">å‡ºé”™äº†ï¼š${error.message}</div>`;
        });
}

/**
 * åˆ›å»ºç­”é¢˜ç•Œé¢
 * åŠŸèƒ½ï¼šæ„å»ºç­”é¢˜é¡µé¢UIå’Œäº¤äº’
 * å‚æ•°ï¼šcontainer - å®¹å™¨å…ƒç´ , questions - é¢˜ç›®æ•°ç»„, quizType - ç­”é¢˜ç±»å‹
 * è¿”å›å€¼ï¼šæ— 
 */
function createQuizInterface(container, questions, quizType) {
    const currentIndex = getState('questionIndex');
    const question = questions[currentIndex];
    
    // æ„å»ºç­”é¢˜ç•Œé¢HTML
    const html = `
        <div class="quiz-container">
            <div class="progress-bar">
                <div class="progress" style="width: ${(currentIndex + 1) * 10}%"></div>
            </div>
            <div class="question-counter">é¢˜ç›® ${currentIndex + 1}/10</div>
            <div class="timer">å‰©ä½™æ—¶é—´: <span id="countdown">300</span>ç§’</div>
            <div class="question">${question.question}</div>
            <div class="options">
                ${question.options.map((option, idx) => `
                    <div class="option" data-index="${idx}">
                        <input type="radio" name="answer" value="${idx}" id="option${idx}">
                        <label for="option${idx}">${option}</label>
                    </div>
                `).join('')}
            </div>
            <button class="submit-btn" disabled>æäº¤ç­”æ¡ˆ</button>
        </div>
    `;
    
    container.innerHTML = html;
    
    // ç»‘å®šäº‹ä»¶å¤„ç†
    bindQuizEvents(container, questions, quizType);
}

/**
 * å¯åŠ¨ç­”é¢˜è®¡æ—¶å™¨
 * åŠŸèƒ½ï¼šä¸ºç­”é¢˜è®¾ç½®å€’è®¡æ—¶
 * è¿”å›å€¼ï¼šæ— 
 */
function startQuizTimer() {
    let timeLeft = 300; // 5åˆ†é’Ÿ
    const timerElement = document.getElementById('countdown');
    
    const timer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = timeLeft;
        
        if (timeLeft <= 0) {
            clearInterval(timer);
            handleTimeUp();
        }
    }, 1000);
    
    // ä¿å­˜timer IDä»¥ä¾¿æ¸…ç†
    setState('currentTimer', timer);
}

/**
 * å¤„ç†ç­”é¢˜è¶…æ—¶
 * åŠŸèƒ½ï¼šå¤„ç†ç­”é¢˜æ—¶é—´ç”¨å®Œçš„æƒ…å†µ
 * è¿”å›å€¼ï¼šæ— 
 */
function handleTimeUp() {
    const answers = getState('answers');
    const quizType = getState('quizType');
    
    // è‡ªåŠ¨æäº¤å½“å‰ç­”æ¡ˆ
    calculateScore(answers, quizType).then(score => {
        showResults(score);
    });
}

/**
 * æ˜¾ç¤ºç­”é¢˜ç»“æœ
 * åŠŸèƒ½ï¼šå±•ç¤ºç­”é¢˜åˆ†æ•°å’Œåé¦ˆ
 * å‚æ•°ï¼šscore - å¾—åˆ†å¯¹è±¡ {score, total, isPerfect}
 * è¿”å›å€¼ï¼šæ— 
 */
function showResults(score) {
    const container = document.querySelector('.quiz-container');
    
    if (score.isPerfect) {
        showCongratulations(container);
    } else {
        container.innerHTML = `
            <div class="results">
                <h2>ç­”é¢˜å®Œæˆ</h2>
                <div class="score">å¾—åˆ†ï¼š${score.score}/${score.total}</div>
                <div class="feedback">ç»§ç»­åŠªåŠ›ï¼Œäº‰å–æ»¡åˆ†ï¼</div>
                <button onclick="navigateTo('home')">è¿”å›é¦–é¡µ</button>
            </div>
        `;
    }
}

/**
 * æ˜¾ç¤ºé¢˜ç›®
 * åŠŸèƒ½ï¼šå±•ç¤ºå•ä¸ªé¢˜ç›®
 * å‚æ•°ï¼šquestion - é¢˜ç›®æ•°æ®, container - å®¹å™¨å…ƒç´ , index - é¢˜ç›®åºå·
 * è¿”å›å€¼ï¼šæ— 
 */
function displayQuestion(question, container, index) {
    // åˆ›å»ºé¢˜ç›®å…ƒç´ 
    // æ˜¾ç¤ºé¢˜ç›®å†…å®¹å’Œé€‰é¡¹
    // ç»‘å®šé€‰é¡¹ç‚¹å‡»äº‹ä»¶
}

/**
 * è¯„åˆ†ç³»ç»Ÿ
 * åŠŸèƒ½ï¼šè®¡ç®—ç­”é¢˜åˆ†æ•°å¹¶æ˜¾ç¤ºç»“æœ
 * å‚æ•°ï¼šanswers - ç”¨æˆ·ç­”æ¡ˆ, quizType - ç­”é¢˜ç±»å‹
 * è¿”å›å€¼ï¼šåˆ†æ•°å¯¹è±¡ {score, total, isPerfect}
 */
function calculateScore(answers, quizType) {
    // è·å–æ­£ç¡®ç­”æ¡ˆ
    // æ¯”å¯¹ç”¨æˆ·ç­”æ¡ˆ
    // è®¡ç®—å¾—åˆ†
    // åˆ¤æ–­æ˜¯å¦æ»¡åˆ†
}

/**
 * æ˜¾ç¤ºç‰¹æ•ˆ
 * åŠŸèƒ½ï¼šå±•ç¤ºæ­å–œç‰¹æ•ˆ
 * å‚æ•°ï¼šcontainer - å®¹å™¨å…ƒç´ , quizType - ç­”é¢˜ç±»å‹
 * è¿”å›å€¼ï¼šæ— 
 */
function showCongratulations(container) {
    // åˆ›å»ºç‰¹æ•ˆå®¹å™¨
    container.innerHTML = `
        <div class="congratulations">
            <div class="firework-container"></div>
            <h1 class="congrats-title">ğŸ‰ æ­å–œé€šè¿‡ï¼ğŸ‰</h1>
            <div class="score-perfect">æ»¡åˆ†ï¼</div>
            <div class="stars"></div>
            <button onclick="navigateTo('home')" class="home-btn">è¿”å›é¦–é¡µ</button>
        </div>
    `;

    // æ·»åŠ çƒŸèŠ±ç‰¹æ•ˆ
    createFireworks(container.querySelector('.firework-container'));
    
    // æ·»åŠ æ˜Ÿæ˜ŸåŠ¨ç”»
    createStars(container.querySelector('.stars'));
    
    // æ’­æ”¾éŸ³æ•ˆ
    playCongratsSound();
}

/**
 * åˆ›å»ºçƒŸèŠ±ç‰¹æ•ˆ
 * åŠŸèƒ½ï¼šä½¿ç”¨Canvasåˆ›å»ºçƒŸèŠ±åŠ¨ç”»
 * å‚æ•°ï¼šcontainer - ç‰¹æ•ˆå®¹å™¨
 * è¿”å›å€¼ï¼šæ— 
 */
function createFireworks(container) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // è®¾ç½®ç”»å¸ƒå°ºå¯¸
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;
    container.appendChild(canvas);
    
    // çƒŸèŠ±ç²’å­ç±»
    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.velocity = {
                x: Math.random() * 6 - 3,
                y: Math.random() * 6 - 3
            };
            this.alpha = 1;
        }
        
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${this.color}, ${this.alpha})`;
            ctx.fill();
        }
        
        update() {
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.alpha -= 0.01;
            this.draw();
        }
    }
    
    // åˆ›å»ºçƒŸèŠ±
    function createFirework(x, y) {
        const particles = [];
        const colors = [
            '255, 182, 193', // ç²‰çº¢
            '255, 215, 0',   // é‡‘è‰²
            '0, 191, 255'    // è“è‰²
        ];
        
        for (let i = 0; i < 50; i++) {
            particles.push(new Particle(
                x,
                y,
                colors[Math.floor(Math.random() * colors.length)]
            ));
        }
        return particles;
    }
    
    // åŠ¨ç”»å¾ªç¯
    let fireworks = [];
    let animationFrame;
    
    function animate() {
        animationFrame = requestAnimationFrame(animate);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // éšæœºåˆ›å»ºæ–°çƒŸèŠ±
        if (Math.random() < 0.05) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            fireworks = fireworks.concat(createFirework(x, y));
        }
        
        // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
        fireworks = fireworks.filter(particle => {
            particle.update();
            return particle.alpha > 0;
        });
        
        // å¦‚æœæ²¡æœ‰æ´»è·ƒçš„ç²’å­ï¼Œåœæ­¢åŠ¨ç”»
        if (fireworks.length === 0) {
            cancelAnimationFrame(animationFrame);
        }
    }
    
    // å¯åŠ¨åŠ¨ç”»
    animate();
}

/**
 * åˆ›å»ºæ˜Ÿæ˜ŸåŠ¨ç”»
 * åŠŸèƒ½ï¼šæ·»åŠ é—ªçƒçš„æ˜Ÿæ˜ŸèƒŒæ™¯
 * å‚æ•°ï¼šcontainer - æ˜Ÿæ˜Ÿå®¹å™¨
 * è¿”å›å€¼ï¼šæ— 
 */
function createStars(container) {
    // åˆ›å»ºå¤šä¸ªæ˜Ÿæ˜Ÿå…ƒç´ 
    for (let i = 0; i < 20; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        star.style.animationDelay = `${Math.random() * 2}s`;
        container.appendChild(star);
    }
}

/**
 * æ’­æ”¾éŸ³æ•ˆ
 * åŠŸèƒ½ï¼šæ’­æ”¾æ­å–œéŸ³æ•ˆ
 * è¿”å›å€¼ï¼šæ— 
 */
function playCongratsSound() {
    const audio = new Audio('/assets/congrats.mp3');
    audio.play().catch(error => {
        console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', error);
    });
}

// æ·»åŠ ç›¸å…³CSSæ ·å¼
const congratsStyles = `
.congratulations {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
}

.firework-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
}

.congrats-title {
    font-size: 2.5em;
    color: #fff;
    text-align: center;
    margin-bottom: 20px;
    animation: bounce 1s ease infinite;
}

.score-perfect {
    font-size: 1.8em;
    color: #ffd700;
    margin-bottom: 30px;
    animation: pulse 2s ease infinite;
}

.home-btn {
    padding: 15px 30px;
    font-size: 1.2em;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.home-btn:hover {
    transform: scale(1.1);
}

.star {
    position: absolute;
    width: 4px;
    height: 4px;
    background: #fff;
    border-radius: 50%;
    animation: twinkle 1s ease infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes twinkle {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}
`;

// å°†æ ·å¼æ·»åŠ åˆ°æ–‡æ¡£ä¸­
const styleSheet = document.createElement('style');
styleSheet.textContent = congratsStyles;
document.head.appendChild(styleSheet);
```

### æ¨¡å—ä¸‰ï¼šèµ„æºç®¡ç†

#### åŠŸèƒ½æè¿°
ç®¡ç†åº”ç”¨æ‰€éœ€çš„å„ç§èµ„æºï¼ŒåŒ…æ‹¬æ ·å¼ã€é—®é¢˜åº“å’Œç‰¹æ•ˆèµ„æºã€‚

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * åŠ è½½é—®é¢˜åº“
 * åŠŸèƒ½ï¼šä»Cloudflare KVè·å–æŒ‡å®šç±»å‹çš„é¢˜ç›®æ•°æ®
 * å‚æ•°ï¼šquizType - ç­”é¢˜ç±»å‹(æŒ‰ç« æ“ä½œ/è¿è§„æ“ä½œ)
 * è¿”å›å€¼ï¼šPromise<é—®é¢˜æ•°ç»„>
 */
async function loadQuestions(quizType) {
    try {
        // ä»Cloudflare KVè·å–é¢˜åº“æ•°æ®
        const questionsJson = await NAMESPACE.get('Test_Title');
        if (!questionsJson) {
            throw new Error('é¢˜åº“æ•°æ®ä¸å­˜åœ¨');
        }
        
        // è§£æJSON
        const questions = JSON.parse(questionsJson);
        
        // è¿”å›å¯¹åº”ç±»å‹çš„é¢˜ç›®
        return questions[quizType] || [];
    } catch (error) {
        console.error('åŠ è½½é¢˜åº“å¤±è´¥:', error);
        // è¿”å›ç©ºæ•°ç»„æˆ–é»˜è®¤é¢˜ç›®
        return [];
    }
}

/**
 * åŠ è½½ç‰¹æ•ˆèµ„æº
 * åŠŸèƒ½ï¼šåŠ è½½æ­å–œç‰¹æ•ˆæ‰€éœ€èµ„æº
 * å‚æ•°ï¼šeffectType - ç‰¹æ•ˆç±»å‹
 * è¿”å›å€¼ï¼šç‰¹æ•ˆèµ„æºå¯¹è±¡
 */
function loadEffects(effectType) {
    // è¿”å›ç‰¹æ•ˆèµ„æº
}
```

### æ¨¡å—å››ï¼šå“åº”å¼è®¾è®¡

#### åŠŸèƒ½æè¿°
ç¡®ä¿åº”ç”¨åœ¨ä¸åŒè®¾å¤‡ä¸Šçš„æ­£ç¡®æ˜¾ç¤ºå’ŒåŠŸèƒ½ã€‚

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * æ£€æµ‹è®¾å¤‡ç±»å‹
 * åŠŸèƒ½ï¼šåˆ¤æ–­å½“å‰è®¿é—®è®¾å¤‡ç±»å‹
 * è¿”å›å€¼ï¼šè®¾å¤‡ç±»å‹å­—ç¬¦ä¸² ('mobile', 'tablet', 'desktop')
 */
function detectDevice() {
    // æ£€æµ‹è®¾å¤‡ç±»å‹
    // è¿”å›å¯¹åº”å­—ç¬¦ä¸²
}

/**
 * é€‚é…å±å¹•
 * åŠŸèƒ½ï¼šæ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´å¸ƒå±€
 * å‚æ•°ï¼šdeviceType - è®¾å¤‡ç±»å‹
 * è¿”å›å€¼ï¼šæ— 
 */
function adaptToScreen(deviceType) {
    // æ ¹æ®è®¾å¤‡ç±»å‹åº”ç”¨ä¸åŒæ ·å¼
    // è°ƒæ•´äº¤äº’æ–¹å¼
}

/**
 * å¯ç”¨å…¨å±
 * åŠŸèƒ½ï¼šå°†æŒ‡å®šå…ƒç´ åˆ‡æ¢åˆ°å…¨å±æ¨¡å¼
 * å‚æ•°ï¼šelement - ç›®æ ‡å…ƒç´ 
 * è¿”å›å€¼ï¼šæ˜¯å¦æˆåŠŸåˆ‡æ¢åˆ°å…¨å±æ¨¡å¼
 */
function enableFullscreen(element) {
    // è·¨æµè§ˆå™¨å…¨å±APIæ”¯æŒ
    if (element.requestFullscreen) {
        element.requestFullscreen();
    } else if (element.webkitRequestFullscreen) { /* Safari */
        element.webkitRequestFullscreen();
    } else if (element.msRequestFullscreen) { /* IE11 */
        element.msRequestFullscreen();
    }
    
    // æ£€æŸ¥æ˜¯å¦æˆåŠŸè¿›å…¥å…¨å±
    return document.fullscreenElement !== null ||
           document.webkitFullscreenElement !== null ||
           document.msFullscreenElement !== null;
}

/**
 * é€€å‡ºå…¨å±
 * åŠŸèƒ½ï¼šé€€å‡ºå…¨å±æ¨¡å¼
 * è¿”å›å€¼ï¼šæ— 
 */
function exitFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.webkitExitFullscreen) { /* Safari */
        document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { /* IE11 */
        document.msExitFullscreen();
    }
}
```

### æ¨¡å—äº”ï¼šç¦»çº¿æ”¯æŒ

#### åŠŸèƒ½æè¿°
ç¡®ä¿åº”ç”¨åœ¨ç½‘ç»œä¸å¯ç”¨æ—¶ä»èƒ½æä¾›åŸºæœ¬åŠŸèƒ½ã€‚

#### å‡½æ•°è®¾è®¡

```javascript
/**
 * åˆå§‹åŒ–ç¦»çº¿æ”¯æŒ
 * åŠŸèƒ½ï¼šæ³¨å†ŒService Workerå¹¶ç¼“å­˜å¿…è¦èµ„æº
 * è¿”å›å€¼ï¼šPromise
 */
async function initOfflineSupport() {
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('/sw.js');
            console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
        } catch (error) {
            console.error('Service Worker æ³¨å†Œå¤±è´¥:', error);
        }
    }
}

/**
 * ç¼“å­˜ç®¡ç†å™¨
 * åŠŸèƒ½ï¼šç®¡ç†æœ¬åœ°ç¼“å­˜æ•°æ®
 */
const CacheManager = {
    /**
     * ä¿å­˜é¢˜åº“åˆ°æœ¬åœ°
     * å‚æ•°ï¼šquestions - é¢˜åº“æ•°æ®
     * è¿”å›å€¼ï¼šPromise
     */
    async saveQuestionsToCache(questions) {
        try {
            localStorage.setItem('cached_questions', JSON.stringify(questions));
            localStorage.setItem('questions_cache_time', Date.now());
        } catch (error) {
            console.error('ç¼“å­˜é¢˜åº“å¤±è´¥:', error);
        }
    },

    /**
     * ä»æœ¬åœ°è·å–é¢˜åº“
     * è¿”å›å€¼ï¼šPromise<é¢˜åº“æ•°æ®>
     */
    async getQuestionsFromCache() {
        try {
            const cached = localStorage.getItem('cached_questions');
            const cacheTime = localStorage.getItem('questions_cache_time');
            
            // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
            if (cached && cacheTime && (Date.now() - cacheTime) < 24 * 60 * 60 * 1000) {
                return JSON.parse(cached);
            }
            return null;
        } catch (error) {
            console.error('è¯»å–ç¼“å­˜é¢˜åº“å¤±è´¥:', error);
            return null;
        }
    },

    /**
     * ä¿å­˜ç­”é¢˜è¿›åº¦
     * å‚æ•°ï¼šquizType - ç­”é¢˜ç±»å‹, answers - ç­”æ¡ˆæ•°ç»„
     * è¿”å›å€¼ï¼šæ— 
     */
    saveProgress(quizType, answers) {
        try {
            localStorage.setItem(`quiz_progress_${quizType}`, JSON.stringify(answers));
        } catch (error) {
            console.error('ä¿å­˜è¿›åº¦å¤±è´¥:', error);
        }
    },

    /**
     * åŠ è½½ç­”é¢˜è¿›åº¦
     * å‚æ•°ï¼šquizType - ç­”é¢˜ç±»å‹
     * è¿”å›å€¼ï¼šç­”æ¡ˆæ•°ç»„æˆ–null
     */
    loadProgress(quizType) {
        try {
            const saved = localStorage.getItem(`quiz_progress_${quizType}`);
            return saved ? JSON.parse(saved) : null;
        } catch (error) {
            console.error('åŠ è½½è¿›åº¦å¤±è´¥:', error);
            return null;
        }
    }
};

/**
 * ä¿®æ”¹åçš„é¢˜åº“åŠ è½½å‡½æ•°
 * åŠŸèƒ½ï¼šä¼˜å…ˆä»æœ¬åœ°ç¼“å­˜åŠ è½½é¢˜åº“ï¼Œå¤±è´¥åˆ™ä»æœåŠ¡å™¨åŠ è½½
 * å‚æ•°ï¼šquizType - ç­”é¢˜ç±»å‹
 * è¿”å›å€¼ï¼šPromise<é—®é¢˜æ•°ç»„>
 */
async function loadQuestions(quizType) {
    try {
        // å…ˆå°è¯•ä»ç¼“å­˜åŠ è½½
        const cachedQuestions = await CacheManager.getQuestionsFromCache();
        if (cachedQuestions) {
            return cachedQuestions[quizType] || [];
        }
        
        // ç¼“å­˜ä¸å¯ç”¨æ—¶ä»æœåŠ¡å™¨åŠ è½½
        const questionsJson = await NAMESPACE.get('Test_Title');
        if (!questionsJson) {
            throw new Error('é¢˜åº“æ•°æ®ä¸å­˜åœ¨');
        }
        
        const questions = JSON.parse(questionsJson);
        
        // ä¿å­˜åˆ°ç¼“å­˜
        await CacheManager.saveQuestionsToCache(questions);
        
        return questions[quizType] || [];
    } catch (error) {
        console.error('åŠ è½½é¢˜åº“å¤±è´¥:', error);
        // è¿”å›é»˜è®¤é¢˜ç›®
        return getDefaultQuestions(quizType);
    }
}

/**
 * è·å–é»˜è®¤é¢˜ç›®
 * åŠŸèƒ½ï¼šå½“æ— æ³•åŠ è½½é¢˜åº“æ—¶æä¾›åŸºç¡€é¢˜ç›®
 * å‚æ•°ï¼šquizType - ç­”é¢˜ç±»å‹
 * è¿”å›å€¼ï¼šåŸºç¡€é¢˜ç›®æ•°ç»„
 */
function getDefaultQuestions(quizType) {
    // è¿”å›ä¸€äº›åŸºç¡€çš„å®‰å…¨ç›¸å…³é¢˜ç›®
    return [
        {
            id: 'default1',
            question: 'å®‰å…¨ç”Ÿäº§æœ€é‡è¦çš„æ˜¯ä»€ä¹ˆï¼Ÿ',
            options: [
                'æé«˜æ•ˆç‡',
                'éµå®ˆè§„ç« åˆ¶åº¦',
                'å®Œæˆä»»åŠ¡',
                'æŠ€æœ¯åˆ›æ–°'
            ],
            correctAnswer: 1,
            explanation: 'éµå®ˆè§„ç« åˆ¶åº¦æ˜¯å®‰å…¨ç”Ÿäº§çš„åŸºç¡€'
        }
        // å¯ä»¥æ·»åŠ æ›´å¤šé»˜è®¤é¢˜ç›®...
    ];
}
```

### Service Worker å®ç°

åˆ›å»º `sw.js` æ–‡ä»¶ï¼š

```javascript
const CACHE_NAME = 'safety-quiz-v1';
const CACHE_URLS = [
    '/',
    '/index.html',
    '/styles.css',
    '/app.js'
];

// Service Worker å®‰è£…
self.addEventListener('install', event => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then(cache => cache.addAll(CACHE_URLS))
    );
});

// ç¼“å­˜ä¼˜å…ˆç­–ç•¥
self.addEventListener('fetch', event => {
    event.respondWith(
        caches.match(event.request)
            .then(response => response || fetch(event.request))
    );
});
```

## æ•°æ®ç»“æ„è®¾è®¡

### åº”ç”¨çŠ¶æ€

```javascript
const appState = {
    currentPage: 'home', // å½“å‰é¡µé¢
    videoType: null, // å½“å‰è§†é¢‘ç±»å‹
    quizType: null, // å½“å‰ç­”é¢˜ç±»å‹
    answers: [], // ç”¨æˆ·ç­”æ¡ˆ
    score: null, // åˆ†æ•°
    questionIndex: 0, // å½“å‰é¢˜ç›®ç´¢å¼•
    deviceType: 'mobile' // è®¾å¤‡ç±»å‹
};
```

### è§†é¢‘æº

```javascript
const videoSources = {
    compliant: "", // å®‰å…¨è§†é¢‘URLï¼ˆå¾…å®šï¼‰
    nonCompliant: "" // ä¸å®‰å…¨è§†é¢‘URLï¼ˆå¾…å®šï¼‰
};
```

### Cloudflare KVé¢˜åº“è®¾è®¡

é¢˜åº“å°†å­˜å‚¨åœ¨Cloudflare KVç©ºé—´ä¸­ï¼Œå˜é‡åä¸º`Test_Title`ï¼Œå€¼ä¸ºJSONæ ¼å¼çš„é¢˜åº“æ•°æ®ã€‚JSONç»“æ„è®¾è®¡å¦‚ä¸‹ï¼š

```javascript
// é¢˜åº“JSONç»“æ„
{
  "compliant": [ // æŒ‰ç« æ“ä½œé¢˜åº“
    {
      "id": "c1", // é¢˜ç›®ID
      "question": "åœ¨é«˜ç©ºä½œä¸šæ—¶ï¼Œä»¥ä¸‹å“ªç§åšæ³•æ˜¯æ­£ç¡®çš„ï¼Ÿ", // é¢˜ç›®å†…å®¹
      "options": [ // å››ä¸ªé€‰é¡¹
        "ä½¿ç”¨æœªç»æ£€æŸ¥çš„å®‰å…¨å¸¦",
        "æ­£ç¡®ä½©æˆ´å®‰å…¨å¸½å’Œå®‰å…¨å¸¦",
        "ä¸ºäº†å·¥ä½œæ–¹ä¾¿ä¸ç³»å®‰å…¨å¸¦",
        "ç©¿ç€æ‹–é‹è¿›è¡Œä½œä¸š"
      ],
      "correctAnswer": 1, // æ­£ç¡®é€‰é¡¹ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
      "explanation": "æ­£ç¡®ä½©æˆ´å®‰å…¨å¸½å’Œå®‰å…¨å¸¦æ˜¯é«˜ç©ºä½œä¸šçš„åŸºæœ¬å®‰å…¨è¦æ±‚" // è§£é‡Šè¯´æ˜
    },
    {
      "id": "c2",
      "question": "å‘ç°è®¾å¤‡æ•…éšœæ—¶ï¼Œæ­£ç¡®çš„åšæ³•æ˜¯ï¼Ÿ",
      "options": [
        "ç»§ç»­ä½¿ç”¨å¹¶ç­‰å¾…è‡ªç„¶ä¿®å¤",
        "è‡ªè¡Œæ‹†å¸ç»´ä¿®",
        "ç«‹å³åœæ­¢ä½¿ç”¨å¹¶æŠ¥å‘Šä¸»ç®¡",
        "æ‰¾åŒäº‹è¯¢é—®æ˜¯å¦å¯ä»¥ç»§ç»­ä½¿ç”¨"
      ],
      "correctAnswer": 2,
      "explanation": "è®¾å¤‡æ•…éšœåº”ç«‹å³åœæ­¢ä½¿ç”¨å¹¶æŠ¥å‘Šä¸»ç®¡ï¼Œç”±ä¸“ä¸šäººå‘˜å¤„ç†"
    },
    // ...æ›´å¤šé¢˜ç›®
  ],
  "nonCompliant": [ // è¿è§„æ“ä½œé¢˜åº“
    {
      "id": "nc1",
      "question": "åœ¨æ²¡æœ‰å®‰å…¨æªæ–½çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•é¿å…ç”µæ°”è®¾å¤‡å¸¦ç”µä½œä¸šçš„é£é™©ï¼Ÿ",
      "options": [
        "ç©¿ç»ç¼˜é‹å¹¶ä½¿ç”¨ç»ç¼˜å·¥å…·",
        "ç¡®ä¿æ‰‹éƒ¨å¹²ç‡¥",
        "å…ˆåˆ‡æ–­ç”µæºå†è¿›è¡Œä½œä¸š",
        "å¿«é€Ÿå®Œæˆä½œä¸šå‡å°‘æ¥è§¦æ—¶é—´"
      ],
      "correctAnswer": 2,
      "explanation": "å¸¦ç”µä½œä¸šå‰å¿…é¡»åˆ‡æ–­ç”µæºï¼Œæ˜¯æœ€åŸºæœ¬çš„å®‰å…¨è§„èŒƒ"
    },
    // ...æ›´å¤šé¢˜ç›®
  ]
}
```

### è·¯ç”±é…ç½®

```javascript
const routes = {
    home: {
        render: renderHomePage
    },
    video: {
        render: renderVideoPage,
        params: ['videoType']
    },
    quiz: {
        render: renderQuizPage,
        params: ['quizType']
    },
    result: {
        render: renderResultPage,
        params: ['quizType', 'score']
    }
};
```

## éƒ¨ç½²è§„åˆ’

æœ€ç»ˆå°†æ‰€æœ‰ä»£ç åˆå¹¶åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ŒåŒ…å«HTMLã€CSSå’ŒJavaScriptã€‚è¯¥æ–‡ä»¶é€‚åˆéƒ¨ç½²åˆ°Cloudflare Workersã€‚å»ºè®®é‡‡ç”¨ä»¥ä¸‹ç»“æ„ï¼š

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨ç®¡ç†äº¤äº’é¡µé¢</title>
    <style>
        /* CSSæ ·å¼ */
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        // JavaScriptä»£ç 
    </script>
</body>
</html>
```

## Cloudflare Workersé…ç½®

### 1. åˆ›å»ºwrangler.tomlé…ç½®æ–‡ä»¶

```toml
name = "safety-quiz"
type = "webpack"
account_id = "your_account_id"
workers_dev = true
route = ""
zone_id = ""

[site]
bucket = "./public"
entry-point = "workers-site"

[build]
command = "npm run build"
upload.format = "service-worker"

[build.upload]
dir = "dist"

[env.production]
name = "safety-quiz-prod"
route = "your.domain.com/*"

[env.staging]
name = "safety-quiz-staging"
route = "staging.your.domain.com/*"

# KVå‘½åç©ºé—´é…ç½®
kv_namespaces = [
  { binding = "NAMESPACE", id = "your_namespace_id", preview_id = "your_preview_namespace_id" }
]
```

### 2. Workerè„šæœ¬é…ç½®

åˆ›å»º`worker.js`æ–‡ä»¶ï¼š

```javascript
import { getAssetFromKV } from '@cloudflare/kv-asset-handler'

addEventListener('fetch', event => {
  event.respondWith(handleRequest(event))
})

async function handleRequest(event) {
  try {
    // å¤„ç†APIè¯·æ±‚
    if (event.request.url.includes('/api/')) {
      return await handleApiRequest(event.request)
    }
    
    // å¤„ç†é™æ€èµ„æº
    return await getAssetFromKV(event, {
      cacheControl: {
        browserTTL: 60 * 60 * 24, // 24å°æ—¶æµè§ˆå™¨ç¼“å­˜
        edgeTTL: 60 * 60 * 24 * 365 // 365å¤©è¾¹ç¼˜ç¼“å­˜
      }
    })
  } catch (e) {
    return new Response('Error: ' + e.message, { status: 500 })
  }
}

async function handleApiRequest(request) {
  const url = new URL(request.url)
  
  // è·å–é¢˜åº“æ•°æ®
  if (url.pathname === '/api/questions') {
    try {
      const questions = await NAMESPACE.get('Test_Title')
      return new Response(questions, {
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'public, max-age=3600'
        }
      })
    } catch (error) {
      return new Response(JSON.stringify({ error: 'è·å–é¢˜åº“å¤±è´¥' }), {
        status: 500,
        headers: { 'Content-Type': 'application/json' }
      })
    }
  }
  
  return new Response('Not Found', { status: 404 })
}
```

### 3. KVå‘½åç©ºé—´è®¾ç½®æ­¥éª¤

1. åˆ›å»ºKVå‘½åç©ºé—´ï¼š
```bash
wrangler kv:namespace create "QUIZ_NAMESPACE"
```

2. è·å–å‘½åç©ºé—´IDå¹¶æ·»åŠ åˆ°wrangler.tomlï¼š
```toml
kv_namespaces = [
  { binding = "NAMESPACE", id = "xxx" }
]
```

3. åˆ›å»ºé¢„è§ˆå‘½åç©ºé—´ï¼š
```bash
wrangler kv:namespace create "QUIZ_NAMESPACE_PREVIEW" --preview
```

4. æ·»åŠ é¢„è§ˆå‘½åç©ºé—´IDï¼š
```toml
kv_namespaces = [
  { binding = "NAMESPACE", id = "xxx", preview_id = "yyy" }
]
```

### 4. éƒ¨ç½²æ­¥éª¤

1. å®‰è£…wrangler CLIï¼š
```bash
npm install -g @cloudflare/wrangler
```

2. ç™»å½•Cloudflareè´¦å·ï¼š
```bash
wrangler login
```

3. æ„å»ºé¡¹ç›®ï¼š
```bash
npm run build
```

4. å‘å¸ƒåˆ°Workersï¼š
```bash
wrangler publish
```

### 5. ç¯å¢ƒå˜é‡é…ç½®

åœ¨Cloudflare Workersçš„ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼š

```
ENVIRONMENT=production
ALLOWED_ORIGINS=https://your.domain.com
API_TOKEN=your_api_token
```

### 6. å®‰å…¨é…ç½®

1. é…ç½®CORSç­–ç•¥ï¼š
```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type'
}

function handleOptions(request) {
  return new Response(null, {
    headers: corsHeaders
  })
}
```

2. é…ç½®å®‰å…¨å¤´ï¼š
```javascript
const securityHeaders = {
  'Content-Security-Policy': "default-src 'self'; img-src 'self' data: https:; media-src 'self' https:;",
  'X-XSS-Protection': '1; mode=block',
  'X-Frame-Options': 'DENY',
  'X-Content-Type-Options': 'nosniff',
  'Referrer-Policy': 'strict-origin-when-cross-origin'
}
```

### 7. ç›‘æ§å’Œæ—¥å¿—

1. é…ç½®Workersåˆ†æï¼š
```javascript
addEventListener('fetch', event => {
  const start = Date.now()
  
  event.respondWith(
    handleRequest(event).then(response => {
      const end = Date.now()
      
      // è®°å½•å“åº”æ—¶é—´
      console.log(`Request processed in ${end - start}ms`)
      
      return response
    })
  )
})
```

2. é”™è¯¯è·Ÿè¸ªï¼š
```javascript
addEventListener('error', event => {
  // å‘é€é”™è¯¯åˆ°ç›‘æ§ç³»ç»Ÿ
  console.error('Workeré”™è¯¯:', event.message)
})
```

æ­¤é…ç½®æä¾›äº†å®Œæ•´çš„éƒ¨ç½²ç¯å¢ƒï¼ŒåŒ…æ‹¬å¼€å‘ã€é¢„è§ˆå’Œç”Ÿäº§ç¯å¢ƒçš„è®¾ç½®ï¼Œä»¥åŠå¿…è¦çš„å®‰å…¨æªæ–½å’Œç›‘æ§åŠŸèƒ½ã€‚

## å¼€å‘ç¯å¢ƒé…ç½®

### 1. é¡¹ç›®ä¾èµ–

```json
{
    "name": "safety-quiz",
    "version": "1.0.0",
    "dependencies": {
        "@cloudflare/kv-asset-handler": "^0.3.0",
        "@cloudflare/wrangler": "^3.0.0",
        "webpack": "^5.88.0",
        "webpack-cli": "^5.1.0"
    },
    "devDependencies": {
        "jest": "^29.0.0",
        "prettier": "^3.0.0",
        "eslint": "^8.0.0"
    },
    "scripts": {
        "dev": "wrangler dev",
        "build": "webpack --mode production",
        "test": "jest",
        "format": "prettier --write .",
        "lint": "eslint ."
    }
}
```

### 2. å¼€å‘å·¥å…·é…ç½®

#### ESLinté…ç½®
```json
{
    "extends": ["eslint:recommended"],
    "env": {
        "browser": true,
        "es2021": true,
        "worker": true
    },
    "rules": {
        "no-console": ["error", { "allow": ["warn", "error"] }],
        "no-unused-vars": "warn"
    }
}
```

#### Prettieré…ç½®
```json
{
    "semi": true,
    "singleQuote": true,
    "tabWidth": 2,
    "printWidth": 100
}
```

## æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

ä½¿ç”¨Jestè¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œé‡ç‚¹æµ‹è¯•ä»¥ä¸‹ç»„ä»¶ï¼š

```javascript
// è·¯ç”±æµ‹è¯•
describe('Router', () => {
    test('should navigate to correct page', () => {
        navigateTo('quiz');
        expect(getState('currentPage')).toBe('quiz');
    });
});

// ç­”é¢˜é€»è¾‘æµ‹è¯•
describe('Quiz', () => {
    test('should calculate score correctly', () => {
        const answers = [1, 2, 1, 3];
        const score = calculateScore(answers, 'compliant');
        expect(score.total).toBe(4);
    });
});

// ç‰¹æ•ˆç»„ä»¶æµ‹è¯•
describe('Congratulations', () => {
    test('should create firework particles', () => {
        const particles = createFirework(100, 100);
        expect(particles.length).toBe(50);
    });
});
```

### 2. é›†æˆæµ‹è¯•

```javascript
describe('Application Flow', () => {
    test('complete quiz flow', async () => {
        // åˆå§‹åŒ–åº”ç”¨
        await initApp();
        
        // å¯¼èˆªåˆ°ç­”é¢˜é¡µé¢
        navigateTo('quiz');
        
        // æ¨¡æ‹Ÿç­”é¢˜
        const answers = [1, 1, 1, 1];
        submitAnswers(answers);
        
        // éªŒè¯ç»“æœ
        const score = getState('score');
        expect(score).toBeDefined();
    });
});
```

### 3. æ€§èƒ½æµ‹è¯•

ä½¿ç”¨Lighthouseè¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œç›®æ ‡æŒ‡æ ‡ï¼š
- First Contentful Paint (FCP) < 1.5s
- Time to Interactive (TTI) < 3.0s
- Cumulative Layout Shift (CLS) < 0.1

## é”™è¯¯å¤„ç†ç­–ç•¥

### 1. å…¨å±€é”™è¯¯å¤„ç†

```javascript
window.onerror = function(message, source, lineno, colno, error) {
    console.error('å…¨å±€é”™è¯¯:', {
        message,
        source,
        lineno,
        colno,
        error
    });
    
    // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
    showErrorNotification('ç³»ç»Ÿé‡åˆ°é—®é¢˜ï¼Œè¯·åˆ·æ–°é‡è¯•');
    
    return true;
};

// å¤„ç†Promiseå¼‚å¸¸
window.onunhandledrejection = function(event) {
    console.error('æœªå¤„ç†çš„Promiseå¼‚å¸¸:', event.reason);
    showErrorNotification('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
};
```

### 2. ä¸šåŠ¡é”™è¯¯å¤„ç†

```javascript
class BusinessError extends Error {
    constructor(code, message) {
        super(message);
        this.code = code;
    }
}

const ErrorCodes = {
    QUIZ_NOT_FOUND: 'QUIZ_001',
    INVALID_ANSWER: 'QUIZ_002',
    VIDEO_LOAD_FAILED: 'VIDEO_001'
};

function handleBusinessError(error) {
    if (error instanceof BusinessError) {
        switch (error.code) {
            case ErrorCodes.QUIZ_NOT_FOUND:
                showErrorNotification('é¢˜åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
                break;
            case ErrorCodes.INVALID_ANSWER:
                showErrorNotification('ç­”æ¡ˆæ ¼å¼ä¸æ­£ç¡®');
                break;
            case ErrorCodes.VIDEO_LOAD_FAILED:
                showErrorNotification('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                break;
            default:
                showErrorNotification('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    } else {
        console.error('æœªçŸ¥é”™è¯¯:', error);
        showErrorNotification('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜');
    }
}
```

## æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### 1. èµ„æºä¼˜åŒ–

```javascript
// å›¾ç‰‡æ‡’åŠ è½½
function lazyLoadImages() {
    const images = document.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                observer.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}

// ä»£ç åˆ†å‰²
const routeComponents = {
    home: () => import('./components/Home.js'),
    quiz: () => import('./components/Quiz.js'),
    video: () => import('./components/Video.js')
};
```

### 2. ç¼“å­˜ç­–ç•¥

```javascript
// é™æ€èµ„æºç¼“å­˜
const CACHE_CONFIG = {
    images: {
        maxAge: 7 * 24 * 60 * 60, // 7å¤©
        staleWhileRevalidate: 24 * 60 * 60 // 1å¤©
    },
    fonts: {
        maxAge: 30 * 24 * 60 * 60 // 30å¤©
    },
    scripts: {
        maxAge: 24 * 60 * 60 // 1å¤©
    }
};

// åº”ç”¨ç¼“å­˜æ¸…ç†
function clearAppCache() {
    if ('caches' in window) {
        caches.keys().then(cacheNames => {
            return Promise.all(
                cacheNames.map(cacheName => {
                    if (cacheName.startsWith('app-')) {
                        return caches.delete(cacheName);
                    }
                })
            );
        });
    }
}
```

## éƒ¨ç½²è§„åˆ’

æœ€ç»ˆå°†æ‰€æœ‰ä»£ç åˆå¹¶åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼ŒåŒ…å«HTMLã€CSSå’ŒJavaScriptã€‚è¯¥æ–‡ä»¶é€‚åˆéƒ¨ç½²åˆ°Cloudflare Workersã€‚å»ºè®®é‡‡ç”¨ä»¥ä¸‹ç»“æ„ï¼š

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨ç®¡ç†äº¤äº’é¡µé¢</title>
    <style>
        /* CSSæ ·å¼ */
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        // JavaScriptä»£ç 
    </script>
</body>
</html>
```

## Cloudflare Workersé…ç½®

### 1. åˆ›å»ºwrangler.tomlé…ç½®æ–‡ä»¶

```toml
name = "safety-quiz"
type = "webpack"
account_id = "your_account_id"
workers_dev = true
route = ""
zone_id = ""

[site]
bucket = "./public"
entry-point = "workers-site"

[build]
command = "npm run build"
upload.format = "service-worker"

[build.upload]
dir = "dist"

[env.production]
name = "safety-quiz-prod"
route = "your.domain.com/*"

[env.staging]
name = "safety-quiz-staging"
route = "staging.your.domain.com/*"

# KVå‘½åç©ºé—´é…ç½®
kv_namespaces = [
  { binding = "NAMESPACE", id = "your_namespace_id", preview_id = "your_preview_namespace_id" }
]
```

### 2. Workerè„šæœ¬é…ç½®

åˆ›å»º`worker.js`æ–‡ä»¶ï¼š

```javascript
import { getAssetFromKV } from '@cloudflare/kv-asset-handler'

addEventListener('fetch', event => {
  event.respondWith(handleRequest(event))
})

async function handleRequest(event) {
  try {
    // å¤„ç†APIè¯·æ±‚
    if (event.request.url.includes('/api/')) {
      return await handleApiRequest(event.request)
    }
    
    // å¤„ç†é™æ€èµ„æº
    return await getAssetFromKV(event, {
      cacheControl: {
        browserTTL: 60 * 60 * 24, // 24å°æ—¶æµè§ˆå™¨ç¼“å­˜
        edgeTTL: 60 * 60 * 24 * 365 // 365å¤©è¾¹ç¼˜ç¼“å­˜
      }
    })
  } catch (e) {
    return new Response('Error: ' + e.message, { status: 500 })
  }
}

async function handleApiRequest(request) {
  const url = new URL(request.url)
  
  // è·å–é¢˜åº“æ•°æ®
  if (url.pathname === '/api/questions') {
    try {
      const questions = await NAMESPACE.get('Test_Title')
      return new Response(questions, {
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'public, max-age=3600'
        }
      })
    } catch (error) {
      return new Response(JSON.stringify({ error: 'è·å–é¢˜åº“å¤±è´¥' }), {
        status: 500,
        headers: { 'Content-Type': 'application/json' }
      })
    }
  }
  
  return new Response('Not Found', { status: 404 })
}
```

### 3. KVå‘½åç©ºé—´è®¾ç½®æ­¥éª¤

1. åˆ›å»ºKVå‘½åç©ºé—´ï¼š
```bash
wrangler kv:namespace create "QUIZ_NAMESPACE"
```

2. è·å–å‘½åç©ºé—´IDå¹¶æ·»åŠ åˆ°wrangler.tomlï¼š
```toml
kv_namespaces = [
  { binding = "NAMESPACE", id = "xxx" }
]
```

3. åˆ›å»ºé¢„è§ˆå‘½åç©ºé—´ï¼š
```bash
wrangler kv:namespace create "QUIZ_NAMESPACE_PREVIEW" --preview
```

4. æ·»åŠ é¢„è§ˆå‘½åç©ºé—´IDï¼š
```toml
kv_namespaces = [
  { binding = "NAMESPACE", id = "xxx", preview_id = "yyy" }
]
```

### 4. éƒ¨ç½²æ­¥éª¤

1. å®‰è£…wrangler CLIï¼š
```bash
npm install -g @cloudflare/wrangler
```

2. ç™»å½•Cloudflareè´¦å·ï¼š
```bash
wrangler login
```

3. æ„å»ºé¡¹ç›®ï¼š
```bash
npm run build
```

4. å‘å¸ƒåˆ°Workersï¼š
```bash
wrangler publish
```

### 5. ç¯å¢ƒå˜é‡é…ç½®

åœ¨Cloudflare Workersçš„ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼š

```
ENVIRONMENT=production
ALLOWED_ORIGINS=https://your.domain.com
API_TOKEN=your_api_token
```

### 6. å®‰å…¨é…ç½®

1. é…ç½®CORSç­–ç•¥ï¼š
```javascript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
  'Access-Control-Allow-Headers': 'Content-Type'
}

function handleOptions(request) {
  return new Response(null, {
    headers: corsHeaders
  })
}
```

2. é…ç½®å®‰å…¨å¤´ï¼š
```javascript
const securityHeaders = {
  'Content-Security-Policy': "default-src 'self'; img-src 'self' data: https:; media-src 'self' https:;",
  'X-XSS-Protection': '1; mode=block',
  'X-Frame-Options': 'DENY',
  'X-Content-Type-Options': 'nosniff',
  'Referrer-Policy': 'strict-origin-when-cross-origin'
}
```

### 7. ç›‘æ§å’Œæ—¥å¿—

1. é…ç½®Workersåˆ†æï¼š
```javascript
addEventListener('fetch', event => {
  const start = Date.now()
  
  event.respondWith(
    handleRequest(event).then(response => {
      const end = Date.now()
      
      // è®°å½•å“åº”æ—¶é—´
      console.log(`Request processed in ${end - start}ms`)
      
      return response
    })
  )
})
```

2. é”™è¯¯è·Ÿè¸ªï¼š
```javascript
addEventListener('error', event => {
  // å‘é€é”™è¯¯åˆ°ç›‘æ§ç³»ç»Ÿ
  console.error('Workeré”™è¯¯:', event.message)
})
```

æ­¤é…ç½®æä¾›äº†å®Œæ•´çš„éƒ¨ç½²ç¯å¢ƒï¼ŒåŒ…æ‹¬å¼€å‘ã€é¢„è§ˆå’Œç”Ÿäº§ç¯å¢ƒçš„è®¾ç½®ï¼Œä»¥åŠå¿…è¦çš„å®‰å…¨æªæ–½å’Œç›‘æ§åŠŸèƒ½ã€‚ 